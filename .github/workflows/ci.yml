name: CI

on:
  push:
    branches: ['dev']
  pull_request:
    branches: ['main']

jobs:
  test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            mode: native
          - name: linux-aarch64
            runner: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            mode: cross
          - name: macos-x86_64
            runner: macos-15-intel
            target: x86_64-apple-darwin
            mode: native
          - name: macos-aarch64
            runner: macos-latest
            target: aarch64-apple-darwin
            mode: native
          - name: windows-x86_64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            mode: native

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.mode == 'cross'
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Build and test (unit)
        if: matrix.mode == 'native'
        run: cargo test --target ${{ matrix.target }} --lib --tests --bins

      - name: Prepare rustc wrapper for doctests (unix)
        if: matrix.mode == 'native' && runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target
          cat > target/rustc-doctest-wrapper.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          real_rustc="$1"
          shift
          "$real_rustc" "$@"
          out=""
          for ((i=1; i<=$#; i++)); do
            if [[ "${!i}" == "-o" ]]; then
              j=$((i+1))
              out="${!j}"
              break
            fi
          done
          if [[ -n "$out" && "$(basename "$out")" == "rust_out" ]]; then
            shopt -s nullglob
            libs=("$SAAL_LIB_DIR"/lib*.so "$SAAL_LIB_DIR"/lib*.dylib "$SAAL_LIB_DIR"/*.dll)
            if [[ ${#libs[@]} -gt 0 ]]; then
              cp "${libs[@]}" "$(dirname "$out")"/
            fi
          fi
          EOF
          chmod +x target/rustc-doctest-wrapper.sh

      - name: Doc tests (unix)
        if: matrix.mode == 'native' && runner.os != 'Windows'
        env:
          RUST_BACKTRACE: 1
          RUSTDOCFLAGS: --test-args=--nocapture
          RUSTC_WRAPPER: ${{ github.workspace }}/target/rustc-doctest-wrapper.sh
          SAAL_LIB_DIR: ${{ github.workspace }}/target/${{ matrix.target }}/debug
        shell: bash
        run: cargo test --doc --target ${{ matrix.target }}

      - name: Prepare rustc wrapper for doctests (windows)
        if: matrix.mode == 'native' && runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path target -Force | Out-Null
          @"
          @echo off
          setlocal enabledelayedexpansion
          set "REAL_RUSTC=%1"
          shift
          "%REAL_RUSTC%" %*
          if errorlevel 1 exit /b %errorlevel%
          set "OUT="
          :parse
          if "%1"=="" goto after
          if "%1"=="-o" (
            set "OUT=%2"
            goto after
          )
          shift
          goto parse
          :after
          if not "%OUT%"=="" (
            for %%f in ("%OUT%") do (
              set "OUTDIR=%%~dpf"
              set "OUTNAME=%%~nxf"
            )
            if /I "!OUTNAME!"=="rust_out.exe" (
              for %%l in ("%SAAL_LIB_DIR%\\*.dll") do copy /y "%%~fl" "!OUTDIR!" >NUL
            )
          )
          "@ | Set-Content -Path target\\rustc-doctest-wrapper.cmd -Encoding ASCII

      - name: Doc tests (windows)
        if: matrix.mode == 'native' && runner.os == 'Windows'
        env:
          RUST_BACKTRACE: 1
          RUSTDOCFLAGS: --test-args=--nocapture
          RUSTC_WRAPPER: ${{ github.workspace }}\\target\\rustc-doctest-wrapper.cmd
          SAAL_LIB_DIR: ${{ github.workspace }}\\target\\${{ matrix.target }}\\debug
        shell: pwsh
        run: cargo test --doc --target ${{ matrix.target }}

      - name: Build and test (cross, unit)
        if: matrix.mode == 'cross'
        run: cross test --target ${{ matrix.target }} --lib --tests --bins

      - name: Doc tests (cross)
        if: matrix.mode == 'cross'
        run: echo "Skipping doctests for cross targets (doctest binaries are not runnable on this host)."
